<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sistem Gudang PT SMS - Ultimate Pro 2.0 + PDF & Notif</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial,sans-serif;padding:15px;background:#f4f6f9;}
h2,h3{color:#2c3e50;}
input,select,button{padding:6px;margin:4px;}
button{background:#27ae60;color:white;border:none;cursor:pointer;}
button:hover{opacity:0.8;}
table{border-collapse:collapse;width:100%;background:white;margin-top:10px;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}
th{background:#34495e;color:white;}
.box{background:white;padding:15px;margin-bottom:20px;border-radius:6px;}
.warning{color:red;font-weight:bold;}
.popup{position:fixed;top:10px;right:10px;background:#e74c3c;color:white;padding:10px;border-radius:6px;z-index:1000;}
</style>
</head>
<body>

<h2>SISTEM GUDANG PT SAMUDRA MANDIRI SENTOSA</h2>

<div class="box">
<h3>Login</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="loginStatus"></p>
</div>

<div id="mainApp" style="display:none;">

<!-- MASTER BARANG -->
<div class="box">
<h3>Master Barang</h3>
<input id="kode" placeholder="Kode Barang">
<input id="nama" placeholder="Nama Barang">
<select id="unit">
<option>kg</option><option>pcs</option><option>box</option><option>roll</option><option>ball</option>
<option>dos</option><option>M3</option><option>liter</option><option>ton</option><option>tins</option>
<option>drum</option><option>sheet</option><option>ujung</option>
</select>
<input id="min" type="number" placeholder="Minimum Stok">
<select id="gudang">
<option>Ingredients</option>
<option>Label</option>
<option>ATK</option>
<option>General Store A</option>
<option>General Store B</option>
<option>Tambak</option>
</select>
<button onclick="tambahBarang()">Tambah Barang</button>
</div>

<!-- REQUEST DEPARTEMEN -->
<div class="box">
<h3>Request Barang Departemen</h3>
<select id="departemenRequest">
<option>Produksi</option>
<option>QC</option>
<option>Administrasi</option>
</select>
<input list="barangList" id="kodeRequest" placeholder="Kode Barang">
<datalist id="barangList"></datalist>
<input type="number" id="qtyRequest" placeholder="Qty">
<button onclick="buatRequest()">Buat Request</button>
</div>

<!-- BARANG MASUK -->
<div class="box" id="gudangSection" style="display:none;">
<h3>Barang Masuk / Stock</h3>
<input list="barangList" id="kodeMasuk" placeholder="Kode Barang">
<input type="number" id="qtyMasuk" placeholder="Qty">
<input placeholder="No PO" id="noPo">
<input placeholder="Supplier" id="supplier">
<input placeholder="Link Foto" id="fotoLink">
<select id="modeMasuk">
<option value="stock">Stock</option>
<option value="transit">Transit</option>
</select>
<button onclick="masuk()">Proses Masuk</button>
</div>

<!-- STOK GUDANG -->
<div class="box">
<h3>Stok Per Gudang</h3>
<button onclick="printDiv('stokTable')">Print Stok</button>
<button onclick="generatePDF('stokTable','Laporan Stok Gudang')">PDF Stok</button>
<table>
<thead>
<tr><th>Gudang</th><th>Kode</th><th>Nama</th><th>Unit</th><th>Stok</th><th>Status</th></tr>
</thead>
<tbody id="stokTable"></tbody>
</table>
<canvas id="stokChart" height="150"></canvas>
</div>

<!-- RIWAYAT -->
<div class="box">
<h3>Riwayat Transaksi</h3>
<input id="filterTanggal" placeholder="YYYY-MM-DD">
<select id="filterGudang">
<option value="">Semua Gudang</option>
<option>Ingredients</option>
<option>Label</option>
<option>ATK</option>
<option>General Store A</option>
<option>General Store B</option>
<option>Tambak</option>
</select>
<input id="filterKode" placeholder="Kode Barang">
<select id="filterTipe">
<option value="">Semua</option>
<option>Masuk</option>
<option>Keluar</option>
<option>Transit</option>
</select>
<button onclick="applyFilter()">Filter</button>
<button onclick="exportExcel()">Export Excel</button>
<button onclick="printDiv('riwayatTable')">Print Riwayat</button>
<button onclick="generatePDF('riwayatTable','Laporan Riwayat')">PDF Riwayat</button>
<table>
<thead>
<tr><th>Tanggal</th><th>Tipe</th><th>Gudang</th><th>Kode</th><th>Qty</th><th>User</th></tr>
</thead>
<tbody id="riwayatTable"></tbody>
</table>
</div>

<!-- PRS APPROVAL GM -->
<div class="box" id="gmSection" style="display:none;">
<h3>PRS Pending Approval GM</h3>
<table>
<thead>
<tr><th>No PRS</th><th>Withdrawal ID</th><th>Kode</th><th>Qty</th><th>Departemen</th><th>User</th><th>Status</th><th>Aksi</th></tr>
</thead>
<tbody id="prsTable"></tbody>
</table>
<button onclick="printDiv('prsTable')">Print PRS</button>
<button onclick="generatePDF('prsTable','Laporan PRS')">PDF PRS</button>
</div>

<div id="popupNotif" class="popup" style="display:none;">Stok Minimum!</div>

</div>

<script>
// ================= FIREBASE CONFIG =================
var firebaseConfig = {
 apiKey: "AIzaSyAucO3yaRtvL-v9zCK_6-ThNJVT-kRF3jg",
    authDomain: "gudang-anto-2026.firebaseapp.com",
    databaseURL: "https://gudang-anto-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gudang-anto-2026",
    storageBucket: "gudang-anto-2026.firebasestorage.app",
    messagingSenderId: "711961129196",
    appId: "1:711961129196:web:7e2d2e74539e112dfff5c9"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.database();
var auth=firebase.auth();
var currentUser=null;
var role="";

// ================= LOGIN =================
function login(){
  var email=document.getElementById("email").value;
  var pass=document.getElementById("password").value;
  auth.signInWithEmailAndPassword(email,pass)
  .then(u=>{
    currentUser=u.user;
    document.getElementById("loginStatus").innerText="Login sukses: "+currentUser.email;
    document.getElementById("mainApp").style.display="block";
    loadBarang(); loadStok(); loadRiwayat(); loadPRS();
    if(email.includes("gm")) role="gm";
    else if(email.includes("departemen")) role="departemen";
    else role="gudang";
    if(role!="gudang") document.getElementById("gudangSection").style.display="none";
    if(role!="gm") document.getElementById("gmSection").style.display="none";
  }).catch(err=>document.getElementById("loginStatus").innerText=err.message);
}

// ================= MASTER BARANG =================
function tambahBarang(){
  if(!currentUser){alert("Login dulu");return;}
  var k=document.getElementById("kode").value;
  var n=document.getElementById("nama").value;
  var u=document.getElementById("unit").value;
  var m=parseInt(document.getElementById("min").value)||0;
  var g=document.getElementById("gudang").value;
  if(!k||!n){alert("Isi data");return;}
  db.ref("barang/"+k).set({nama:n,unit:u,min:m,gudang:g});
  document.getElementById("kode").value="";
  document.getElementById("nama").value="";
  document.getElementById("unit").value="kg";
  document.getElementById("min").value="";
  document.getElementById("gudang").value="Ingredients";
  loadBarang();
}

function loadBarang(){
  db.ref("barang").once("value",snap=>{
    var html="";
    snap.forEach(c=>html+="<option value='"+c.key+"'>");
    document.getElementById("barangList").innerHTML=html;
  });
}

// ================= REQUEST =================
function buatRequest(){
  if(!currentUser){alert("Login dulu");return;}
  var d=document.getElementById("departemenRequest").value;
  var k=document.getElementById("kodeRequest").value;
  var q=parseInt(document.getElementById("qtyRequest").value);
  if(!d||!k||!q){alert("Isi data");return;}
  var now=new Date();
  var yyyy=now.getFullYear(),mm=("0"+(now.getMonth()+1)).slice(-2),dd=("0"+now.getDate()).slice(-2);
  var prs_no="PRS-"+yyyy+mm+dd+"-"+Math.floor(Math.random()*900+100);
  var newRequest=db.ref("withdrawal").push();
  newRequest.set({tanggal:now.toISOString(),departemen:d,kode:k,qty:q,status:"Menunggu Proses Gudang",user:currentUser.email,prs_no:prs_no});
  db.ref("prs/"+prs_no).set({no_prs:prs_no,withdrawal_id:newRequest.key,approval:false,status:"Pending",user:currentUser.email,tanggal:now.toISOString()});
  document.getElementById("qtyRequest").value="";
  document.getElementById("kodeRequest").value="";
}

// ================= MASUK =================
function masuk(){
  if(!currentUser){alert("Login dulu");return;}
  var k=document.getElementById("kodeMasuk").value;
  var q=parseInt(document.getElementById("qtyMasuk").value);
  var po=document.getElementById("noPo").value;
  var sup=document.getElementById("supplier").value;
  var foto=document.getElementById("fotoLink").value;
  var mode=document.getElementById("modeMasuk").value;
  if(!k||!q){alert("Isi data");return;}
  db.ref("barang/"+k).once("value",function(b){
    if(!b.val()){alert("Kode barang tidak ada"); return;}
    var g=b.val().gudang;
    if(mode=="stock"){db.ref("stok/"+k).once("value",s=>db.ref("stok/"+k).set((s.val()||0)+q));}
    db.ref("barang_masuk").push({tanggal:new Date().toISOString(),no_po:po,kode:k,supplier:sup,qty:q,mode:mode,gudang:g,foto_link:foto,user:currentUser.email});
    if(mode=="transit"){db.ref("serah_terima").push({tanggal:new Date().toISOString(),departemen:"[Departemen tujuan]",kode:k,qty:q,no_po:po,user:currentUser.email});}
  });
  document.getElementById("kodeMasuk").value="";
  document.getElementById("qtyMasuk").value="";
  document.getElementById("noPo").value="";
  document.getElementById("supplier").value="";
  document.getElementById("fotoLink").value="";
}

// ================= STOK & CHART & MINIMUM NOTIF =================
var stokChartObj=null;
function loadStok(){
  db.ref("stok").on("value",snap=>{
    var html="",stokData={};
    snap.forEach(itemSnap=>{
      var kode=itemSnap.key,qty=itemSnap.val();
      db.ref("barang/"+kode).once("value",b=>{
        var nama="-",unit="-",gudang="-",min=0;
        if(b.val()){nama=b.val().nama;unit=b.val().unit;gudang=b.val().gudang;min=b.val().min||0;}
        var status="Aman";
        if(qty<=min){status="<span class='warning'>Minimum</span>"; showNotif(nama,qty);}
        html+="<tr><td>"+gudang+"</td><td>"+kode+"</td><td>"+nama+"</td><td>"+unit+"</td><td>"+qty+"</td><td>"+status+"</td></tr>";
        document.getElementById("stokTable").innerHTML=html;
        stokData[gudang]=(stokData[gudang]||0)+qty;
        renderChart(stokData);
      });
    });
  });
}

function renderChart(data){
  var ctx=document.getElementById('stokChart').getContext('2d');
  var labels=Object.keys(data),values=Object.values(data);
  if(stokChartObj) stokChartObj.destroy();
  stokChartObj=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Stok',data:values,backgroundColor:'#27ae60'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

function showNotif(nama,qty){
  var popup=document.getElementById("popupNotif");
  popup.innerText="Stok Minimum: "+nama+" ("+qty+")";
  popup.style.display="block";
  setTimeout(()=>popup.style.display="none",5000);
}

// ================= RIWAYAT =================
var semuaRiwayat=[];
function loadRiwayat(){
  db.ref("barang_masuk").on("value",snap=>{
    semuaRiwayat=[];snap.forEach(c=>semuaRiwayat.push(c.val()));
    semuaRiwayat.reverse();tampilRiwayat(semuaRiwayat);
  });
}
function tampilRiwayat(data){
  var html="";for(var i=0;i<data.length;i++){var it=data[i];html+="<tr><td>"+it.tanggal+"</td><td>"+it.mode+"</td><td>"+it.gudang+"</td><td>"+it.kode+"</td><td>"+it.qty+"</td><td>"+it.user+"</td></tr>";}
  document.getElementById("riwayatTable").innerHTML=html;
}
function applyFilter(){
  var t=document.getElementById("filterTanggal").value,g=document.getElementById("filterGudang").value,k=document.getElementById("filterKode").value.toLowerCase(),tp=document.getElementById("filterTipe").value,hasil=[];
  for(var i=0;i<semuaRiwayat.length;i++){var item=semuaRiwayat[i];if(t&&item.tanggal.indexOf(t)===-1)continue;if(g&&item.gudang!=g)continue;if(k&&item.kode.toLowerCase().indexOf(k)===-1)continue;if(tp&&item.mode!=tp)continue;hasil.push(item);}
  tampilRiwayat(hasil);
}
function exportExcel(){var table=document.getElementById("riwayatTable");var wb=XLSX.utils.table_to_book(table,{sheet:"Riwayat"});XLSX.writeFile(wb,"Riwayat_Gudang.xlsx");}

// ================= PRINT & PDF =================
function printDiv(divId){var content=document.getElementById(divId).outerHTML;var mywindow=window.open('','Print','height=600,width=800');mywindow.document.write('<html><head><title>Print</title></head><body>');mywindow.document.write(content);mywindow.document.write('</body></html>');mywindow.document.close();mywindow.focus();mywindow.print();mywindow.close();}
function generatePDF(divId,title){const { jsPDF } = window.jspdf;var doc=new jsPDF();doc.text(title,10,10);doc.autoTable({html:'#'+divId,startY:20});doc.save(title+".pdf");}

// ================= PRS APPROVAL GM =================
function loadPRS(){if(role!="gm")return;db.ref("prs").on("value",snap=>{var html="";snap.forEach(c=>{var p=c.val();html+="<tr>";html+="<td>"+p.no_prs+"</td>";html+="<td>"+p.withdrawal_id+"</td>";html+="<td>"+(p.kode||"-")+"</td>";html+="<td>"+(p.qty||"-")+"</td>";html+="<td>"+(p.departemen||"-")+"</td>";html+="<td>"+p.user+"</td>";html+="<td>"+p.status+"</td>";html+="<td><button onclick='approvePRS(\""+c.key+"\")'>Approve</button> <button onclick='rejectPRS(\""+c.key+"\")'>Reject</button></td>";html+="</tr>";});document.getElementById("prsTable").innerHTML=html;});}
function approvePRS(id){db.ref("prs/"+id).update({approval:true,status:"Approved"});}
function rejectPRS(id){db.ref("prs/"+id).update({approval:false,status:"Rejected"});}
</script>

</body>
</html>