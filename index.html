<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sistem Gudang Final Stabil</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>

<body class="bg-gray-100 p-6">

<h1 class="text-2xl font-bold mb-4">SISTEM GUDANG FINAL</h1>

<select id="gudangSelect" class="border p-2 mb-4" onchange="loadBarang()">
<option>Gudang Ingredients</option>
<option>Gudang Label</option>
<option>Gudang ATK</option>
<option>General Store A</option>
<option>General Store B</option>
<option>Gudang Tambak</option>
</select>

<div class="bg-white p-4 rounded shadow mb-4">
<input id="nama" placeholder="Nama Barang" class="border p-2 mr-2">
<input id="stok" type="number" placeholder="Stok" class="border p-2 mr-2">
<input id="minimum" type="number" placeholder="Minimum" class="border p-2 mr-2">

<button onclick="tambahBarang()" class="bg-blue-500 text-white px-4 py-2 rounded">
Tambah
</button>

<button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded ml-2">
Export Excel
</button>
</div>

<h2 class="font-bold mt-4">Data Barang</h2>

<table class="w-full border bg-white mb-6">
<thead>
<tr class="bg-gray-200">
<th class="border p-2">Nama</th>
<th class="border p-2">Stok</th>
<th class="border p-2">Minimum</th>
<th class="border p-2">Aksi</th>
</tr>
</thead>
<tbody id="tabelBarang"></tbody>
</table>

<h2 class="font-bold">Grafik Stok</h2>
<canvas id="chartStok" class="mb-6"></canvas>

<h2 class="font-bold">Riwayat Transaksi</h2>

<table class="w-full border bg-white">
<thead>
<tr class="bg-gray-200">
<th class="border p-2">Tanggal</th>
<th class="border p-2">Gudang</th>
<th class="border p-2">Barang</th>
<th class="border p-2">Tipe</th>
<th class="border p-2">Jumlah</th>
</tr>
</thead>
<tbody id="tabelRiwayat"></tbody>
</table>

<script>

var firebaseConfig = {
  apiKey: "ISI_APIKEY_ANDA",
  authDomain: "ISI_AUTHDOMAIN_ANDA",
  databaseURL: "ISI_DATABASEURL_ANDA",
  projectId: "ISI_PROJECTID_ANDA"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();
var chart = null;

/* TAMBAH BARANG */
function tambahBarang(){

  var gudang = document.getElementById("gudangSelect").value;
  var namaInput = document.getElementById("nama");
  var stokInput = document.getElementById("stok");
  var minimumInput = document.getElementById("minimum");

  var nama = namaInput.value.trim();
  var stok = parseInt(stokInput.value);
  var minimum = parseInt(minimumInput.value);

  if(nama === "" || isNaN(stok) || isNaN(minimum)){
    alert("Isi semua data dengan benar");
    return;
  }

  var id = Date.now();

  db.ref("barang/"+gudang+"/"+id).set({
    nama: nama,
    stok: stok,
    minimum: minimum
  });

  namaInput.value="";
  stokInput.value="";
  minimumInput.value="";
}

/* LOAD BARANG */
function loadBarang(){

  var gudang = document.getElementById("gudangSelect").value;
  var tabel = document.getElementById("tabelBarang");

  db.ref("barang/"+gudang).off();

  db.ref("barang/"+gudang).on("value", function(snapshot){

    tabel.innerHTML="";
    var data = snapshot.val();

    var labels=[];
    var stokData=[];

    if(!data){
      updateChart([],[]);
      return;
    }

    for(var id in data){

      var b = data[id];
      var warna = b.stok <= b.minimum ? "bg-red-200" : "";

      var row = "<tr class='"+warna+"'>";
      row += "<td class='border p-2'>"+b.nama+"</td>";
      row += "<td class='border p-2'>"+b.stok+"</td>";
      row += "<td class='border p-2'>"+b.minimum+"</td>";
      row += "<td class='border p-2'>";
      row += "<button onclick=\"updateStok('"+id+"','masuk')\" class='bg-green-500 text-white px-2 py-1 mr-1 rounded'>+</button>";
      row += "<button onclick=\"updateStok('"+id+"','keluar')\" class='bg-yellow-500 text-white px-2 py-1 rounded'>-</button>";
      row += "</td></tr>";

      tabel.innerHTML += row;

      labels.push(b.nama);
      stokData.push(b.stok);
    }

    updateChart(labels,stokData);
  });

  loadRiwayat();
}

/* UPDATE STOK + SIMPAN RIWAYAT */
function updateStok(id,tipe){

  var gudang = document.getElementById("gudangSelect").value;
  var jumlah = parseInt(prompt("Masukkan jumlah:"));

  if(isNaN(jumlah) || jumlah <= 0) return;

  var ref = db.ref("barang/"+gudang+"/"+id);

  ref.once("value").then(function(snap){

    var barang = snap.val();
    if(!barang) return;

    var stokBaru = tipe === "masuk"
      ? barang.stok + jumlah
      : barang.stok - jumlah;

    if(stokBaru < 0) stokBaru = 0;

    ref.update({stok: stokBaru});

    db.ref("riwayat").push({
      tanggal: new Date().toLocaleString(),
      gudang: gudang,
      barang: barang.nama,
      tipe: tipe,
      jumlah: jumlah
    });

  });
}

/* LOAD RIWAYAT */
function loadRiwayat(){

  var tabel = document.getElementById("tabelRiwayat");

  db.ref("riwayat").limitToLast(50).on("value", function(snapshot){

    tabel.innerHTML="";
    var data = snapshot.val();
    if(!data) return;

    for(var id in data){

      var r = data[id];
      var row = "<tr>";
      row += "<td class='border p-2'>"+r.tanggal+"</td>";
      row += "<td class='border p-2'>"+r.gudang+"</td>";
      row += "<td class='border p-2'>"+r.barang+"</td>";
      row += "<td class='border p-2'>"+r.tipe+"</td>";
      row += "<td class='border p-2'>"+r.jumlah+"</td>";
      row += "</tr>";

      tabel.innerHTML += row;
    }

  });
}

/* UPDATE CHART */
function updateChart(labels,data){

  if(chart){
    chart.destroy();
  }

  var ctx = document.getElementById("chartStok").getContext("2d");

  chart = new Chart(ctx,{
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Stok",
        data: data
      }]
    }
  });
}

/* EXPORT CSV */
function exportExcel(){

  var rows = document.querySelectorAll("#tabelBarang tr");
  var csv = "Nama,Stok,Minimum\n";

  rows.forEach(function(row){
    var cols = row.querySelectorAll("td");
    if(cols.length > 0){
      csv += cols[0].innerText + "," +
             cols[1].innerText + "," +
             cols[2].innerText + "\n";
    }
  });

  var blob = new Blob([csv], {type:"text/csv"});
  var link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "data_gudang.csv";
  link.click();
}

loadBarang();

</script>
</body>
</html>